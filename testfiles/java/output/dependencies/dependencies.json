{
	"java.dependencies" : {
		"text" : "\/*\r\n * The MIT License\r\n *\r\n * Copyright (c) 2011, CloudBees, Inc.\r\n *\r\n * Permission is hereby granted, free of charge, to any person obtaining a copy\r\n * of this software and associated documentation files (the \"Software\"), to deal\r\n * in the Software without restriction, including without limitation the rights\r\n * to use, copy, modify, merge, publish, distribute, sublicense, and\/or sell\r\n * copies of the Software, and to permit persons to whom the Software is\r\n * furnished to do so, subject to the following conditions:\r\n *\r\n * The above copyright notice and this permission notice shall be included in\r\n * all copies or substantial portions of the Software.\r\n *\r\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\n * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r\n * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r\n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r\n * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r\n * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\r\n * THE SOFTWARE.\r\n *\/\r\npackage jenkins.security;\r\n\r\nimport hudson.Extension;\r\nimport jenkins.util.SystemProperties;\r\nimport hudson.Util;\r\nimport hudson.model.Descriptor.FormException;\r\nimport hudson.model.User;\r\nimport hudson.model.UserProperty;\r\nimport hudson.model.UserPropertyDescriptor;\r\nimport hudson.security.ACL;\r\nimport hudson.util.HttpResponses;\r\nimport hudson.util.Secret;\r\nimport jenkins.model.Jenkins;\r\nimport net.sf.json.JSONObject;\r\nimport org.jenkinsci.Symbol;\r\nimport org.kohsuke.stapler.AncestorInPath;\r\nimport org.kohsuke.stapler.DataBoundConstructor;\r\nimport org.kohsuke.stapler.HttpResponse;\r\nimport org.kohsuke.stapler.StaplerRequest;\r\nimport org.kohsuke.stapler.StaplerResponse;\r\n\r\nimport java.io.IOException;\r\nimport java.nio.charset.Charset;\r\nimport java.security.MessageDigest;\r\nimport java.security.SecureRandom;\r\nimport javax.annotation.Nonnull;\r\nimport org.apache.commons.lang.StringUtils;\r\nimport org.kohsuke.accmod.Restricted;\r\nimport org.kohsuke.accmod.restrictions.NoExternalUse;\r\n\r\n\/**\r\n * Remembers the API token for this user, that can be used like a password to login.\r\n *\r\n *\r\n * @author Kohsuke Kawaguchi\r\n * @see ApiTokenFilter\r\n * @since 1.426\r\n *\/\r\npublic class ApiTokenProperty extends UserProperty {\r\n    private volatile Secret apiToken;\r\n    private String test1 = \"http:\/\/8080:localhost\";\r\n    private String test2 = \"http:\/\/8080:localhost\";\/\/This comment should be extracted\r\n\r\n    \/**\r\n     * If enabled, shows API tokens to users with {@link Jenkins#ADMINISTER) permissions.\r\n     * Disabled by default due to the security reasons.\r\n     * If enabled, it restores the original Jenkins behavior (SECURITY-200).\r\n     * @since 1.638\r\n     *\/\r\n    private static final boolean SHOW_TOKEN_TO_ADMINS = \r\n            SystemProperties.getBoolean(ApiTokenProperty.class.getName() + \".showTokenToAdmins\");\r\n    \r\n    \r\n    @DataBoundConstructor\r\n    public ApiTokenProperty() {\r\n        _changeApiToken();\r\n    }\r\n\r\n    \/**\r\n     * We don't let the external code set the API token,\r\n     * but for the initial value of the token we need to compute the seed by ourselves.\r\n     *\/\r\n    \/*package*\/ ApiTokenProperty(String seed) {\r\n        apiToken = Secret.fromString(seed);\r\n    }\r\n\r\n    \/**\r\n     * Gets the API token.\r\n     * The method performs security checks since 1.638. Only the current user and SYSTEM may see it.\r\n     * Users with {@link Jenkins#ADMINISTER} may be allowed to do it using {@link #SHOW_TOKEN_TO_ADMINS}.\r\n     * \r\n     * @return API Token. Never null, but may be {@link Messages#ApiTokenProperty_ChangeToken_TokenIsHidden()}\r\n     *         if the user has no appropriate permissions.\r\n     * @since 1.426, and since 1.638 the method performs security checks\r\n     *\/\r\n    @Nonnull\r\n    public String getApiToken() {\r\n        return hasPermissionToSeeToken() ? getApiTokenInsecure() \r\n                : Messages.ApiTokenProperty_ChangeToken_TokenIsHidden();\r\n    }\r\n    \r\n    @Nonnull\r\n    @Restricted(NoExternalUse.class)\r\n    \/*package*\/ String getApiTokenInsecure() {\r\n        String p = apiToken.getPlainText();\r\n        if (p.equals(Util.getDigestOf(Jenkins.getInstance().getSecretKey()+\":\"+user.getId()))) {\r\n            \/\/ if the current token is the initial value created by pre SECURITY-49 Jenkins, we can't use that.\r\n            \/\/ force using the newer value\r\n            apiToken = Secret.fromString(p=API_KEY_SEED.mac(user.getId()));\r\n        }\r\n        return Util.getDigestOf(p);\r\n    }\r\n\r\n    public boolean matchesPassword(String password) {\r\n        String token = getApiTokenInsecure();\r\n        \/\/ String.equals isn't constant time, but this is\r\n        return MessageDigest.isEqual(password.getBytes(Charset.forName(\"US-ASCII\")),\r\n                token.getBytes(Charset.forName(\"US-ASCII\")));\r\n    }\r\n    \r\n    private boolean hasPermissionToSeeToken() {\r\n        final Jenkins jenkins = Jenkins.getInstance();\r\n\r\n        \/\/ Administrators can do whatever they want\r\n        if (SHOW_TOKEN_TO_ADMINS && jenkins.hasPermission(Jenkins.ADMINISTER)) {\r\n            return true;\r\n        }\r\n        \r\n        \r\n        final User current = User.current();\r\n        if (current == null) { \/\/ Anonymous\r\n            return false;\r\n        }\r\n        \r\n        \/\/ SYSTEM user is always eligible to see tokens\r\n        if (Jenkins.getAuthentication() == ACL.SYSTEM) {\r\n            return true;\r\n        }\r\n             \r\n        \/\/TODO: replace by IdStrategy in newer Jenkins versions\r\n        \/\/return User.idStrategy().equals(user.getId(), current.getId());\r\n        return StringUtils.equals(user.getId(), current.getId());\r\n    }\r\n\r\n    public void changeApiToken() throws IOException {\r\n        user.checkPermission(Jenkins.ADMINISTER);\r\n        _changeApiToken();\r\n        user.save();\r\n    }\r\n\r\n    private void _changeApiToken() {\r\n        byte[] random = new byte[16];   \/\/ 16x8=128bit worth of randomness, since we use md5 digest as the API token\r\n        RANDOM.nextBytes(random);\r\n        apiToken = Secret.fromString(Util.toHexString(random));\r\n    }\r\n\r\n    @Override\r\n    public UserProperty reconfigure(StaplerRequest req, JSONObject form) throws FormException {\r\n        return this;\r\n    }\r\n\r\n    @Extension @Symbol(\"apiToken\")\r\n    public static final class DescriptorImpl extends UserPropertyDescriptor {\r\n        public String getDisplayName() {\r\n            return Messages.ApiTokenProperty_DisplayName();\r\n        }\r\n\r\n        \/**\r\n         * When we are creating a default {@link ApiTokenProperty} for User,\r\n         * we need to make sure it yields the same value for the same user,\r\n         * because there's no guarantee that the property is saved.\r\n         *\r\n         * But we also need to make sure that an attacker won't be able to guess\r\n         * the initial API token value. So we take the seed by hashing the secret + user ID.\r\n         *\/\r\n        public ApiTokenProperty newInstance(User user) {\r\n            return new ApiTokenProperty(API_KEY_SEED.mac(user.getId()));\r\n        }\r\n\r\n        public HttpResponse doChangeToken(@AncestorInPath User u, StaplerResponse rsp) throws IOException {\r\n            ApiTokenProperty p = u.getProperty(ApiTokenProperty.class);\r\n            if (p==null) {\r\n                p = newInstance(u);\r\n                u.addProperty(p);\r\n            } else {\r\n                p.changeApiToken();\r\n            }\r\n            rsp.setHeader(\"script\",\"document.getElementById('apiToken').value='\"+p.getApiToken()+\"'\");\r\n            return HttpResponses.html(p.hasPermissionToSeeToken() \r\n                    ? Messages.ApiTokenProperty_ChangeToken_Success() \r\n                    : Messages.ApiTokenProperty_ChangeToken_SuccessHidden());\r\n        }\r\n    }\r\n\r\n    private static final SecureRandom RANDOM = new SecureRandom();\r\n\r\n    \/**\r\n     * We don't want an API key that's too long, so cut the length to 16 (which produces 32-letter MAC code in hexdump)\r\n     *\/\r\n    private static final HMACConfidentialKey API_KEY_SEED = new HMACConfidentialKey(ApiTokenProperty.class,\"seed\",16);\r\n",
		"subs" : [{
				"java.package" : {
					"text" : "package jenkins.security",
					"subs" : [{
							"java.package_text" : {
								"text" : "jenkins.security",
								"pos" : 1175
							}
						}
					],
					"pos" : 1167
				}
			}, {
				"java.dependencies_single" : {
					"text" : "import hudson.Extension",
					"subs" : [{
							"java.dependencies_text" : {
								"text" : "hudson.Extension",
								"pos" : 1203
							}
						}
					],
					"pos" : 1196
				}
			}, {
				"java.dependencies_single" : {
					"text" : "import jenkins.util.SystemProperties",
					"subs" : [{
							"java.dependencies_text" : {
								"text" : "jenkins.util.SystemProperties",
								"pos" : 1229
							}
						}
					],
					"pos" : 1222
				}
			}, {
				"java.dependencies_single" : {
					"text" : "import hudson.Util",
					"subs" : [{
							"java.dependencies_text" : {
								"text" : "hudson.Util",
								"pos" : 1268
							}
						}
					],
					"pos" : 1261
				}
			}, {
				"java.dependencies_single" : {
					"text" : "import hudson.model.Descriptor.FormException",
					"subs" : [{
							"java.dependencies_text" : {
								"text" : "hudson.model.Descriptor.FormException",
								"pos" : 1289
							}
						}
					],
					"pos" : 1282
				}
			}, {
				"java.dependencies_single" : {
					"text" : "import hudson.model.User",
					"subs" : [{
							"java.dependencies_text" : {
								"text" : "hudson.model.User",
								"pos" : 1336
							}
						}
					],
					"pos" : 1329
				}
			}, {
				"java.dependencies_single" : {
					"text" : "import hudson.model.UserProperty",
					"subs" : [{
							"java.dependencies_text" : {
								"text" : "hudson.model.UserProperty",
								"pos" : 1363
							}
						}
					],
					"pos" : 1356
				}
			}, {
				"java.dependencies_single" : {
					"text" : "import hudson.model.UserPropertyDescriptor",
					"subs" : [{
							"java.dependencies_text" : {
								"text" : "hudson.model.UserPropertyDescriptor",
								"pos" : 1398
							}
						}
					],
					"pos" : 1391
				}
			}, {
				"java.dependencies_single" : {
					"text" : "import hudson.security.ACL",
					"subs" : [{
							"java.dependencies_text" : {
								"text" : "hudson.security.ACL",
								"pos" : 1443
							}
						}
					],
					"pos" : 1436
				}
			}, {
				"java.dependencies_single" : {
					"text" : "import hudson.util.HttpResponses",
					"subs" : [{
							"java.dependencies_text" : {
								"text" : "hudson.util.HttpResponses",
								"pos" : 1472
							}
						}
					],
					"pos" : 1465
				}
			}, {
				"java.dependencies_single" : {
					"text" : "import hudson.util.Secret",
					"subs" : [{
							"java.dependencies_text" : {
								"text" : "hudson.util.Secret",
								"pos" : 1507
							}
						}
					],
					"pos" : 1500
				}
			}, {
				"java.dependencies_single" : {
					"text" : "import jenkins.model.Jenkins",
					"subs" : [{
							"java.dependencies_text" : {
								"text" : "jenkins.model.Jenkins",
								"pos" : 1535
							}
						}
					],
					"pos" : 1528
				}
			}, {
				"java.dependencies_single" : {
					"text" : "import net.sf.json.JSONObject",
					"subs" : [{
							"java.dependencies_text" : {
								"text" : "net.sf.json.JSONObject",
								"pos" : 1566
							}
						}
					],
					"pos" : 1559
				}
			}, {
				"java.dependencies_single" : {
					"text" : "import org.jenkinsci.Symbol",
					"subs" : [{
							"java.dependencies_text" : {
								"text" : "org.jenkinsci.Symbol",
								"pos" : 1598
							}
						}
					],
					"pos" : 1591
				}
			}, {
				"java.dependencies_single" : {
					"text" : "import org.kohsuke.stapler.AncestorInPath",
					"subs" : [{
							"java.dependencies_text" : {
								"text" : "org.kohsuke.stapler.AncestorInPath",
								"pos" : 1628
							}
						}
					],
					"pos" : 1621
				}
			}, {
				"java.dependencies_single" : {
					"text" : "import org.kohsuke.stapler.DataBoundConstructor",
					"subs" : [{
							"java.dependencies_text" : {
								"text" : "org.kohsuke.stapler.DataBoundConstructor",
								"pos" : 1672
							}
						}
					],
					"pos" : 1665
				}
			}, {
				"java.dependencies_single" : {
					"text" : "import org.kohsuke.stapler.HttpResponse",
					"subs" : [{
							"java.dependencies_text" : {
								"text" : "org.kohsuke.stapler.HttpResponse",
								"pos" : 1722
							}
						}
					],
					"pos" : 1715
				}
			}, {
				"java.dependencies_single" : {
					"text" : "import org.kohsuke.stapler.StaplerRequest",
					"subs" : [{
							"java.dependencies_text" : {
								"text" : "org.kohsuke.stapler.StaplerRequest",
								"pos" : 1764
							}
						}
					],
					"pos" : 1757
				}
			}, {
				"java.dependencies_single" : {
					"text" : "import org.kohsuke.stapler.StaplerResponse",
					"subs" : [{
							"java.dependencies_text" : {
								"text" : "org.kohsuke.stapler.StaplerResponse",
								"pos" : 1808
							}
						}
					],
					"pos" : 1801
				}
			}, {
				"java.dependencies_single" : {
					"text" : "import java.io.IOException",
					"subs" : [{
							"java.dependencies_text" : {
								"text" : "java.io.IOException",
								"pos" : 1855
							}
						}
					],
					"pos" : 1848
				}
			}, {
				"java.dependencies_single" : {
					"text" : "import java.nio.charset.Charset",
					"subs" : [{
							"java.dependencies_text" : {
								"text" : "java.nio.charset.Charset",
								"pos" : 1884
							}
						}
					],
					"pos" : 1877
				}
			}, {
				"java.dependencies_single" : {
					"text" : "import java.security.MessageDigest",
					"subs" : [{
							"java.dependencies_text" : {
								"text" : "java.security.MessageDigest",
								"pos" : 1918
							}
						}
					],
					"pos" : 1911
				}
			}, {
				"java.dependencies_single" : {
					"text" : "import java.security.SecureRandom",
					"subs" : [{
							"java.dependencies_text" : {
								"text" : "java.security.SecureRandom",
								"pos" : 1955
							}
						}
					],
					"pos" : 1948
				}
			}, {
				"java.dependencies_single" : {
					"text" : "import javax.annotation.Nonnull",
					"subs" : [{
							"java.dependencies_text" : {
								"text" : "javax.annotation.Nonnull",
								"pos" : 1991
							}
						}
					],
					"pos" : 1984
				}
			}, {
				"java.dependencies_single" : {
					"text" : "import org.apache.commons.lang.StringUtils",
					"subs" : [{
							"java.dependencies_text" : {
								"text" : "org.apache.commons.lang.StringUtils",
								"pos" : 2025
							}
						}
					],
					"pos" : 2018
				}
			}, {
				"java.dependencies_single" : {
					"text" : "import org.kohsuke.accmod.Restricted",
					"subs" : [{
							"java.dependencies_text" : {
								"text" : "org.kohsuke.accmod.Restricted",
								"pos" : 2070
							}
						}
					],
					"pos" : 2063
				}
			}, {
				"java.dependencies_single" : {
					"text" : "import org.kohsuke.accmod.restrictions.NoExternalUse",
					"subs" : [{
							"java.dependencies_text" : {
								"text" : "org.kohsuke.accmod.restrictions.NoExternalUse",
								"pos" : 2109
							}
						}
					],
					"pos" : 2102
				}
			}
		],
		"pos" : 1
	}
}
