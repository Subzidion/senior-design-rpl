{"c.line_comments":{"pos":1,"text":"\/* Simple \/bin\/tree replacement\r\n *\r\n * Copyright (c) 2015  Joachim Nilsson <troglobit@gmail.com>\r\n *\r\n * Permission to use, copy, modify, and\/or distribute this software for any\r\n * purpose with or without fee is hereby granted, provided that the above\r\n * copyright notice and this permission notice appear in all copies.\r\n *\r\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES\r\n * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF\r\n * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR\r\n * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES\r\n * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN\r\n * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF\r\n * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\r\n *\/\r\n\r\n#include <errno.h>\r\n#include <dirent.h>\r\n#include <stdio.h>\r\n#include <stdlib.h>\r\n#include <string.h>\r\n#include <sys\/types.h>\r\n#include <sys\/stat.h>\r\n#include <unistd.h>\r\n\r\nstatic int all = 0;\r\n\r\n\/\/ This is a comment about the filter function\r\nstatic int filter(const struct dirent *entry)\r\n{\r\n\t\/\/ Skip current dir \".\", and prev dir \"..\", from list of files\r\n\tif ((1 == strlen(entry->d_name) && entry->d_name[0] == '.') ||\r\n\t    (2 == strlen(entry->d_name) && !strcmp(entry->d_name, \"..\")))\r\n\t\treturn 0;\r\n\r\n\tif (!all && entry->d_name[0] == '.')\r\n\t\treturn 0;\r\n\t\r\n\treturn 1;\r\n}\r\n\r\nstatic void get_perms(struct stat *st, char *buf, size_t len)\r\n{\r\n\tmode_t m = st->st_mode;\r\n\r\n\tsnprintf(buf, len, \"[%c%c%c%c%c%c%c%c%c%c] \",\r\n\t\t S_ISCHR(m) ? 'c' : S_ISBLK(m) ? 'b' : S_ISFIFO(m) ? 'p' : S_ISLNK(m) ? 'l' : S_ISSOCK(m) ? 's' : '-',\r\n\t\t (m & S_IRUSR) ? 'r' : '-',\r\n\t\t (m & S_IWUSR) ? 'w' : '-',\r\n\t\t (m & S_ISUID ) ? 's' : (m & S_IXUSR) ? 'x' : '-',\r\n\t\t (m & S_IRGRP) ? 'r' : '-',\r\n\t\t (m & S_IWGRP) ? 'w' : '-',\r\n\t\t (m & S_ISGID) ? 's' : (m & S_IXGRP) ? 'x' : '-',\r\n\t\t (m & S_IROTH) ? 'r' : '-',\r\n\t\t (m & S_IWOTH) ? 'w' : '-',\r\n\t\t (m & S_IXOTH) ? 'x' : '-'\r\n\t\t);\r\n}\r\n\r\nstatic int descend(char *path, int show_perms, char *pfx)\r\n{\r\n\tint result = 0; \/\/ This is a comment\r\n\tstruct stat st;\r\n\r\n\tif (-1 == lstat(path, &st))\r\n\t\treturn 1;\r\n\r\n\tif ((st.st_mode & S_IFMT) == S_IFDIR) {\r\n\t\tint i, n;\r\n\t\tstruct dirent **namelist = NULL;\r\n\r\n\t\tn = scandir(path, &namelist, filter, alphasort);\r\n\t\tif (n) {\r\n\t\t\tfor (i = 0; i < n; i++) {\r\n\t\t\t\tchar t = ' ', p[14] = \"\", s[256] = \"\";\r\n\t\t\t\tchar buf[256];\r\n\t\t\t\tchar dir[80];\r\n\r\n\t\t\t\tif (i + 1 == n) {\r\n\t\t\t\t\tprintf(\"%s `- \", pfx);\r\n\t\t\t\t\tsnprintf(dir, sizeof(dir), \"%s     \", pfx);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tprintf(\"%s|-- \", pfx);\r\n\t\t\t\t\tsnprintf(dir, sizeof(dir), \"%s|    \", pfx);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tsnprintf(buf, sizeof(buf), \"%s\/%s\", path, namelist[i]->d_name);\r\n\t\t\t\tif (!lstat(buf, &st)) {\r\n\t\t\t\t\tif (show_perms)\r\n\t\t\t\t\t\tget_perms(&st, p, sizeof(p));\r\n\t\t\t\t\tif ((st.st_mode & S_IFMT) == S_IFDIR)\r\n\t\t\t\t\t\tt = '\/';\r\n\t\t\t\t\tif (S_ISLNK(st.st_mode)) {\r\n\t\t\t\t\t\tsnprintf(s, sizeof(s), \"-> \");\r\n\t\t\t\t\t\tif (-1 == readlink(buf, &s[3], sizeof(s) - 3))\r\n\t\t\t\t\t\t\ts[0] = 0;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\tprintf(\"%s%s%c%s\\n\", p, namelist[i]->d_name, t, s);\r\n\t\t\t\tif (t == '\/')\r\n\t\t\t\t\tresult += descend(buf, show_perms, dir);\r\n\r\n\t\t\t\tfree(namelist[i]);\r\n\t\t\t}\r\n\r\n\t\t\tfree(namelist);\r\n\t\t}\r\n\t} else {\r\n\t\terrno = ENOTDIR;\r\n\t\tresult = -1;\r\n\t}\r\n\r\n\treturn result;\r\n}\r\n\r\nint tree(char *path, int show_perms)\r\n{\r\n\tprintf(\"[%s]\\n\", path);\r\n\treturn descend(path, show_perms, \"\");\r\n}\r\n\r\n\/**\r\n * Local Variables:\r\n *  indent-tabs-mode: t\r\n *  c-file-style: \"linux\"\r\n * End:\r\n *\/\r\n","subs":[{"c.line_comment":{"pos":1047,"text":"\/\/ This is a comment about the filter function\r","subs":[{"c.line_comment_context":{"pos":1047,"text":""}},{"c.line_comment_body":{"pos":1047,"text":"\/\/ This is a comment about the filter function\r","subs":[{"c.line_comment_text":{"pos":1049,"text":" This is a comment about the filter function\r"}}]}}]}},{"c.line_comment":{"pos":1145,"text":"\t\/\/ Skip current dir \".\", and prev dir \"..\", from list of files\r","subs":[{"c.line_comment_context":{"pos":1145,"text":"\t"}},{"c.line_comment_body":{"pos":1146,"text":"\/\/ Skip current dir \".\", and prev dir \"..\", from list of files\r","subs":[{"c.line_comment_text":{"pos":1148,"text":" Skip current dir \".\", and prev dir \"..\", from list of files\r"}}]}}]}},{"c.line_comment":{"pos":2074,"text":"\tint result = 0; \/\/ This is a comment\r","subs":[{"c.line_comment_context":{"pos":2074,"text":"\tint result = 0; "}},{"c.line_comment_body":{"pos":2091,"text":"\/\/ This is a comment\r","subs":[{"c.line_comment_text":{"pos":2093,"text":" This is a comment\r"}}]}}]}}]}}
